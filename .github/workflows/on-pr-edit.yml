# ~~ Generated by projen. To modify, edit .projenrc.py and run "npx projen".

name: on-pr-open-edit
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
concurrency: pr-${{ github.event.pull_request.head.ref }}
jobs:
  deploy-env:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      deploy-env: ${{ steps.get-env.outputs.deploy-env }}
    steps:
      - name: extract compliant deploy environment name
        id: get-env
        run: echo "deploy-env=$(echo ${{ github.event.pull_request.head.ref }} | cut -c -16 | sed -e 's/-*$//' -e 's/[\/_\.]/-/g')$(echo -n ${{ github.event.pull_request.head.ref }} | md5sum | cut -c -4)" >> $GITHUB_OUTPUT
  build:
    needs: deploy-env
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - run: echo "SIMULATING BUILD ${{ needs.deploy-env.outputs.deploy-env }}"
      # - uses: actions/checkout@v3
      # - uses: actions/setup-python@v4
      #   with:
      #     python-version: "3.11"
      # - uses: actions/setup-node@v3
      #   with:
      #     node-version: 18.17.1
      # - id: poetry-cache
      #   uses: actions/cache@v3
      #   with:
      #     path: ~/.local
      #     key: poetry-1.6.1-0
      # - uses: snok/install-poetry@v1
      #   with:
      #     version: 1.6.1
      #     virtualenvs-create: true
      #     virtualenvs-in-project: true
      # - name: AWS login with DEV credentials
      #   uses: aws-actions/configure-aws-credentials@v2
      #   with:
      #     aws-access-key-id: ${{ secrets.ROOFTOP_SOLAR_DEV_AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.ROOFTOP_SOLAR_DEV_AWS_SECRET_KEY }}
      #     aws-region: us-east-1
      # - run: |-
      #     aws codeartifact login --tool pip --domain energysage --domain-owner 659694780082 --repository cloud-engineering
      #     aws codeartifact login --tool npm --domain energysage --domain-owner 659694780082 --repository cloud-engineering
      #     poetry config http-basic.codeartifact aws $(aws codeartifact get-authorization-token --domain energysage --domain-owner 659694780082 --query authorizationToken --output text)
      # - id: cache-deps
      #   uses: actions/cache@v3
      #   with:
      #     path: |-
      #       .venv
      #       .mypy_cache
      #     key: pydeps-${{ hashFiles('**/poetry.lock') }}
      # - run: poetry install --no-interaction --no-root
      # - run: npx projen
      # - run: npx projen build
      # - env:
      #     DEPLOY_ENV: ${{ needs.deploy-env.outputs.deploy-env }}
      #   run: npx cdk synth
      # - uses: actions/upload-artifact@v3
      #   with:
      #     name: cdk synth
      #     path: cdk.out
  deploy-pr-env:
    needs:
      - deploy-env
      - build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment:
      name: ${{ needs.deploy-env.outputs.deploy-env }}
    steps:
      - run: echo "SIMULATING DEPLOY ON ${{ needs.deploy-env.outputs.deploy-env }}"
      # - uses: actions/checkout@v3
      # - uses: actions/setup-python@v4
      #   with:
      #     python-version: "3.11"
      # - uses: actions/setup-node@v3
      #   with:
      #     node-version: 18.17.1
      # - id: poetry-cache
      #   uses: actions/cache@v3
      #   with:
      #     path: ~/.local
      #     key: poetry-1.6.1-0
      # - uses: snok/install-poetry@v1
      #   with:
      #     version: 1.6.1
      #     virtualenvs-create: true
      #     virtualenvs-in-project: true
      # - name: AWS login with DEV credentials
      #   uses: aws-actions/configure-aws-credentials@v2
      #   with:
      #     aws-access-key-id: ${{ secrets.ROOFTOP_SOLAR_DEV_AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.ROOFTOP_SOLAR_DEV_AWS_SECRET_KEY }}
      #     aws-region: us-east-1
      # - run: |-
      #     aws codeartifact login --tool pip --domain energysage --domain-owner 659694780082 --repository cloud-engineering
      #     aws codeartifact login --tool npm --domain energysage --domain-owner 659694780082 --repository cloud-engineering
      #     poetry config http-basic.codeartifact aws $(aws codeartifact get-authorization-token --domain energysage --domain-owner 659694780082 --query authorizationToken --output text)
      # - run: poetry install --no-interaction --no-root
      # - run: npx projen
      # - uses: actions/download-artifact@v3
      #   with:
      #     name: cdk synth
      #     path: cdk.out
      # - run: npx cdk deploy "${{ needs.deploy-env.outputs.deploy-env }}/*" --require-approval never -a cdk.out --outputs-file cdk-outputs.json
  run-system-tests-pr-env:
    needs:
      - deploy-env
      - build
      - deploy-pr-env
    permissions:
      contents: read
    uses: ./.github/workflows/run-system-tests.yml
    with:
      sys_test_env: ${{ needs.deploy-env.outputs.deploy-env }}
    secrets: inherit
